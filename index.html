<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Urbano A Coruña</title>
    <meta name="description" content="Información de rutas de autobús urbano de A Coruña en tiempo real">
    <meta name="theme-color" content="#2196F3">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }
        
        h1 {
            color: #2196F3;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .route-selector {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border: 2px solid #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }
        
        .route-selector label {
            display: block;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1976D2;
            text-align: center;
        }
        
        .route-selector select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background-color: white;
            font-weight: 500;
            cursor: pointer;
        }
        
        .route-selector select:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }
        
        /* Estilos para el interruptor de dirección */
        .direction-toggle {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f8f0;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        
        .direction-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            color: #4CAF50;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            flex: 1;
            text-align: center;
            margin: 0 5px;
        }
        
        .direction-btn.active {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .direction-btn:hover:not(.active) {
            background-color: #e8f5e9;
            transform: translateY(-1px);
        }
        
        .direction-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .direction-text {
            font-size: 14px;
            font-weight: bold;
            line-height: 1.2;
        }
        
        .destination-selector {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border: 2px solid #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }
        
        .destination-selector label {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1976D2;
            text-align: center;
        }
        
        .destination-selector select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background-color: white;
            font-weight: 500;
            cursor: pointer;
        }
        
        .destination-selector select:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }
        
        #map {
            height: 400px;
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .section h2 {
            color: #2196F3;
            font-size: 22px;
            margin-bottom: 15px;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 5px;
        }
        
        .arrival-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .arrival-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .arrival-time {
            font-size: 24px;
            font-weight: bold;
            color: #1976D2;
        }
        
        .arrival-line {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .stops-list {
            list-style: none;
        }
        
        .stop-item {
            padding: 12px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            font-size: 16px;
        }
        
        .stop-item.origin {
            border-left-color: #4CAF50;
            background-color: #e8f5e9;
        }
        
        .stop-item.destination {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        

        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin: 10px 0;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .btn-update {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        
        .btn-update:hover {
            background-color: #1976D2;
        }
        
        .btn-update:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #btnClearCache:hover {
            background-color: #d32f2f !important;
        }
        
        .update-time {
            text-align: center;
            font-size: 16px;
            color: #333;
            margin-top: 15px;
            padding: 12px;
            background-color: #e3f2fd;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 500;
            line-height: 1.4;
        }
        
        @media print {
            .btn-update,
            .route-selector,
            .arrival-info {
                display: none;
            }
            
            #map {
                height: 300px;
            }
            
            .container {
                padding: 10px;
            }
        }
        
        /* Ocultar botones de actualización */
        .btn-update,
        #btnClearCache {
            display: none !important;
        }
        
        /* Estilos para enlaces de mantenimiento discretos */
        .maintenance-links {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background-color: #fafafa;
        }
        
        .maintenance-links .title {
            font-size: 10px;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        .maintenance-links .links {
            font-size: 8px;
            color: #ddd;
        }
        
        .maintenance-links a {
            color: #ddd !important;
            text-decoration: none;
            margin: 0 10px;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.2s ease;
        }
        
        .maintenance-links a:hover {
            color: #999 !important;
            background-color: #f0f0f0;
        }
        
        /* Estilos globales para tarjetas (aplicado en móvil y desktop) */
        .schedule-cards {
            display: block;
        }
        
        /* Ocultar tabla tradicional globalmente */
        .schedule-table {
            display: none;
        }
        
        .schedule-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .schedule-card-header {
            background-color: #2196F3;
            color: white;
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
            margin: -12px -12px 8px -12px;
            font-weight: bold;
            text-align: center;
        }
        
        .schedule-card-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .schedule-card-row:last-child {
            border-bottom: none;
        }
        
        .schedule-card-label {
            font-weight: bold;
            color: #666;
            min-width: 80px;
            font-size: 14px;
        }
        
        .schedule-card-value {
            color: #333;
            text-align: right;
            flex: 1;
            margin-left: 10px;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            #map {
                height: 300px;
            }
            
            .direction-toggle {
                flex-direction: column;
                gap: 10px;
            }
            
            .direction-btn {
                margin: 0;
                padding: 15px 10px;
            }
            
            .direction-text {
                font-size: 16px;
            }
            
            .destination-selector select {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Contenedor con scroll horizontal para tablas */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -10px;
                padding: 0 10px;
            }
        }

        /* Estilos para el interruptor de dirección */
        .direction-toggle {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f8f0; /* Verde claro para el interruptor */
            border-radius: 5px;
            border: 1px solid #4CAF50; /* Borde verde */
        }

        .direction-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            border: none;
            background-color: #f0f8f0; /* Fondo verde claro */
            color: #4CAF50; /* Texto verde */
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 5px;
            flex: 1;
            text-align: center;
        }

        .direction-btn.active {
            background-color: #4CAF50;
            color: white;
        }

        .direction-btn:hover:not(.active) {
            background-color: #e8f5e9;
        }

        .direction-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .destination-selector {
            margin-top: 15px;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border: 2px solid #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .destination-selector label {
            display: block;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1976D2;
            text-align: center;
        }

        .destination-selector select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background-color: white;
            font-weight: 500;
            cursor: pointer;
        }

        .destination-selector select:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rutas habituales del bus de A Coruña</h1>
        
        <div class="route-selector">
            <label for="directionToggle"><img src="icon-192.png" alt="Icono de autobús" style="height: 24px; vertical-align: middle; margin-right: 8px;"> ¿A DÓNDE VAS?</label>
            
            <!-- Interruptor principal -->
            <div class="direction-toggle">
                <button id="idaBtn" class="direction-btn active" onclick="selectDirection('ida')">
                    <span class="direction-icon">🏠➡️</span>
                    <span class="direction-text">IDA DESDE CASA</span>
                </button>
                <button id="vueltaBtn" class="direction-btn" onclick="selectDirection('vuelta')">
                    <span class="direction-icon">🏠⬅️</span>
                    <span class="direction-text">VUELTA HACIA CASA</span>
                </button>
            </div>
            
            <!-- Selector de destino/origen -->
            <div id="destinationSelector" class="destination-selector">
                <label for="destinationSelect">📍 ¿DÓNDE QUIERES IR?</label>
                <select id="destinationSelect">
                    <option value="loading">Cargando destinos...</option>
                </select>
            </div>
        </div>
        
        <div class="section">
            <h2>🕐 Horarios</h2>
            <div id="scheduleInfo">
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando horarios...</div>
                        <div style="font-size: 14px; color: #999;">Obteniendo información actualizada</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="arrivalInfo" class="arrival-info section">
            <h2>⏱️ Próximos buses en E.Glez.López, M.Azaña (Parada 42)</h2>

            <div id="arrivalsList">
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚌</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando tiempos de llegada...</div>
                        <div style="font-size: 14px; color: #999;">Conectando con el servicio en tiempo real</div>
                    </div>
                </div>
            </div>
            <div class="update-time" id="updateTime"></div>
        </div>
        
        <div id="map"></div>
        
        <div class="section">
            <h2>📍 Paradas del recorrido</h2>
            <ul id="stopsList" class="stops-list">
                <li class="loading">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 20px; margin-bottom: 8px;">📍</div>
                        <div style="font-size: 16px; color: #666;">Cargando paradas...</div>
                    </div>
                </li>
            </ul>
        </div>
        
        <!-- Enlaces discretos para funciones de mantenimiento -->
        <div class="maintenance-links">
            <div class="title">Funciones de mantenimiento</div>
            <div class="links">
                <a href="#" onclick="updateArrivalTime(); return false;">Actualizar</a>
                <span>|</span>
                <a href="#" onclick="reloadEverything(); return false;">Recargar</a>
                <span>|</span>
                <a href="#" onclick="showCacheStats(); return false;">Caché</a>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // Configuración de la aplicación
        const BACKEND_API = window.location.origin + '/buscoruna/api';
        let map;
        let routeLayer;
        let linesData = {};
        let stopsData = {};
        

        
        // Variables globales
        let routesConfig = {};
        let currentRoute = {};
        let currentDirection = 'ida'; // 'ida' o 'vuelta'
        
        // Sistema de caché localStorage
        const CACHE_KEYS = {
            GENERAL_DATA: 'busCoruna_generalData',
            LINE_DATA: 'busCoruna_lineData_',
            SCHEDULE_DATA: 'busCoruna_scheduleData_',
            CACHE_VERSION: 'busCoruna_cacheVersion'
        };
        
        const CACHE_VERSION = '1.0.0';
        const CACHE_TTL = {
            STATIC: 7 * 24 * 60 * 60 * 1000, // 7 días para datos estáticos
            DAILY: 24 * 60 * 60 * 1000,      // 24 horas para horarios
            REALTIME: 2 * 60 * 1000          // 2 minutos para tiempo real
        };
        
        // Funciones utilitarias de caché localStorage
        function setCache(key, data, ttl) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    ttl: ttl,
                    version: CACHE_VERSION
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
                console.log(`💾 [localStorage] Guardado: ${key}`);
            } catch (error) {
                console.warn(`⚠️ [localStorage] Error guardando ${key}:`, error);
            }
        }
        
        function getCache(key) {
            try {
                const cached = localStorage.getItem(key);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // Verificar versión
                if (cacheData.version !== CACHE_VERSION) {
                    console.log(`🔄 [localStorage] Versión obsoleta para ${key}, eliminando`);
                    localStorage.removeItem(key);
                    return null;
                }
                
                // Verificar TTL
                const age = Date.now() - cacheData.timestamp;
                if (age > cacheData.ttl) {
                    console.log(`⏰ [localStorage] Caché expirado para ${key}, eliminando`);
                    localStorage.removeItem(key);
                    return null;
                }
                
                console.log(`🎯 [localStorage] Hit: ${key} (edad: ${Math.round(age/1000/60)} min)`);
                return cacheData.data;
            } catch (error) {
                console.warn(`⚠️ [localStorage] Error leyendo ${key}:`, error);
                localStorage.removeItem(key);
                return null;
            }
        }
        
        function clearCache(pattern = null) {
            try {
                if (pattern) {
                    // Limpiar solo claves que coincidan con el patrón
                    Object.keys(localStorage).forEach(key => {
                        if (key.includes(pattern)) {
                            localStorage.removeItem(key);
                            console.log(`🗑️ [localStorage] Eliminado: ${key}`);
                        }
                    });
                } else {
                    // Limpiar todas las claves de la aplicación
                    Object.values(CACHE_KEYS).forEach(key => {
                        if (typeof key === 'string') {
                            localStorage.removeItem(key);
                        } else {
                            // Para claves con prefijos (como LINE_DATA_)
                            Object.keys(localStorage).forEach(storageKey => {
                                if (storageKey.startsWith(key)) {
                                    localStorage.removeItem(storageKey);
                                    console.log(`🗑️ [localStorage] Eliminado: ${storageKey}`);
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.warn('⚠️ [localStorage] Error limpiando caché:', error);
            }
        }
        
        // Cargar configuración de rutas
        async function loadRoutesConfig(forceReload = false) {
            try {
                // Siempre agregar timestamp para evitar caché del navegador y Service Worker
                const timestamp = Date.now();
                const url = `routes.json?t=${timestamp}`;
                console.log('Cargando configuración de rutas desde:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar configuración de rutas');
                }
                
                routesConfig = await response.json();
                console.log('Configuración de rutas cargada:', routesConfig);
                
                // Establecer ruta por defecto
                const defaultRoute = routesConfig.routes.find(r => r.id === routesConfig.defaultRoute);
                if (defaultRoute) {
                    currentRoute = {
                        id: defaultRoute.id,
                        line: defaultRoute.lineId,
                        apiLineId: defaultRoute.apiLineId,
                        originStop: defaultRoute.originStop,
                        destinationStop: defaultRoute.destinationStop,
                        originName: defaultRoute.originName,
                        destinationName: defaultRoute.destinationName
                    };
                }
                
                // Determinar dirección inicial basándose en la ruta por defecto
                if (defaultRoute) {
                    currentDirection = defaultRoute.originStop === 42 ? 'ida' : 'vuelta';
                }
                
                // Actualizar selector de destinos
                updateDestinationSelector();
                
            } catch (error) {
                console.error('Error cargando configuración de rutas:', error);
                // Usar configuración por defecto si falla
                currentRoute = {
                    id: '3-42-482',
                    line: '3',
                    apiLineId: '300',
                    originStop: 42,
                    destinationStop: 482,
                    originName: 'E.Glez.López, M.Azaña',
                    destinationName: 'Maestranza,Metrosid'
                };
            }
        }
        
        // Función para seleccionar dirección (ida/vuelta)
        function selectDirection(direction) {
            console.log('🔄 Cambiando dirección a:', direction);
            currentDirection = direction;
            
            // Actualizar botones
            const idaBtn = document.getElementById('idaBtn');
            const vueltaBtn = document.getElementById('vueltaBtn');
            
            if (direction === 'ida') {
                idaBtn.classList.add('active');
                vueltaBtn.classList.remove('active');
            } else {
                vueltaBtn.classList.add('active');
                idaBtn.classList.remove('active');
            }
            
            // Actualizar selector de destinos
            updateDestinationSelector();
        }
        
        // Actualizar selector de destinos según la dirección
        function updateDestinationSelector() {
            const destinationSelect = document.getElementById('destinationSelect');
            const destinationLabel = document.querySelector('#destinationSelector label');
            
            destinationSelect.innerHTML = '<option value="loading">Cargando opciones...</option>';
            
            if (!routesConfig.routes) {
                console.error('No hay configuración de rutas disponible');
                return;
            }
            
            // Filtrar rutas según la dirección
            const availableRoutes = routesConfig.routes.filter(route => {
                if (route.type === 'separator' || !route.active) return false;
                
                if (currentDirection === 'ida') {
                    // Para ida: origen debe ser 42 (casa)
                    return route.originStop === 42;
                } else {
                    // Para vuelta: destino debe ser 88 (casa)
                    return route.destinationStop === 88;
                }
            });
            
            console.log(`Rutas disponibles para ${currentDirection}:`, availableRoutes);
            
            // Actualizar etiqueta
            if (currentDirection === 'ida') {
                destinationLabel.textContent = '📍 ¿DÓNDE QUIERES IR?';
            } else {
                destinationLabel.textContent = '📍 ¿DESDE DÓNDE VIENES?';
            }
            
            // Limpiar selector
            destinationSelect.innerHTML = '';
            
            // Agregar opciones
            availableRoutes.forEach(route => {
                const option = document.createElement('option');
                option.value = route.id;
                
                if (currentDirection === 'ida') {
                    option.textContent = `Línea ${route.lineId}: ${route.destinationName}`;
                } else {
                    option.textContent = `Línea ${route.lineId}: ${route.originName}`;
                }
                
                destinationSelect.appendChild(option);
            });
            
            // Establecer opción por defecto
            if (availableRoutes.length > 0) {
                destinationSelect.value = availableRoutes[0].id;
                selectRoute(availableRoutes[0].id);
            }
            
            // Agregar event listener
            destinationSelect.addEventListener('change', function() {
                selectRoute(this.value);
            });
        }
        
        // Seleccionar ruta específica
        function selectRoute(routeId) {
            const selectedRoute = routesConfig.routes.find(r => r.id === routeId);
            if (selectedRoute && selectedRoute.type !== 'separator') {
                console.log('🔄 Seleccionando ruta:', selectedRoute);
                
                currentRoute = {
                    id: selectedRoute.id,
                    line: selectedRoute.lineId,
                    apiLineId: selectedRoute.apiLineId,
                    originStop: selectedRoute.originStop,
                    destinationStop: selectedRoute.destinationStop,
                    originName: selectedRoute.originName,
                    destinationName: selectedRoute.destinationName
                };
                
                // Recargar datos con la nueva ruta
                refreshRouteData();
            }
        }
        
                // Recargar datos de la ruta
        function refreshRouteData() {
            console.log('🔄 Recargando datos para ruta:', currentRoute);
            console.log('📊 Estado de caché antes de limpiar:');
            console.log('   - Líneas en caché:', Object.keys(linesData).length);
            console.log('   - Paradas en caché:', Object.keys(stopsData).length);
            
            // Limpiar caché de datos anteriores
            linesData = {};
            stopsData = {};
            
            // Limpiar mapa
            if (routeLayer) {
                routeLayer.clearLayers();
            }
            
            // Limpiar lista de paradas
            const stopsList = document.getElementById('stopsList');
            stopsList.innerHTML = `
                <li class="loading">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 20px; margin-bottom: 8px;">📍</div>
                        <div style="font-size: 16px; color: #666;">Cargando paradas...</div>
                    </div>
                </li>
            `;
            
            // Limpiar tiempos de llegada
            const arrivalsList = document.getElementById('arrivalsList');
            arrivalsList.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚌</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando tiempos de llegada...</div>
                        <div style="font-size: 14px; color: #999;">Conectando con el servicio en tiempo real</div>
                    </div>
                </div>
            `;
            
            // Limpiar horarios
            const scheduleInfo = document.getElementById('scheduleInfo');
            scheduleInfo.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando horarios...</div>
                        <div style="font-size: 14px; color: #999;">Obteniendo información actualizada</div>
                    </div>
                </div>
            `;
            
            console.log('🧹 Caché limpiada completamente');
            
            // Actualizar título de próximos buses
            const arrivalInfo = document.getElementById('arrivalInfo');
            if (arrivalInfo) {
                const h2 = arrivalInfo.querySelector('h2');
                if (h2) {
                    h2.textContent = `⏱️ Próximos buses en ${currentRoute.originName} (Parada ${currentRoute.originStop})`;
                }
            }
            
            // Recargar datos
            getGeneralData();
            getScheduleData();
            getArrivalTime();
        }
        
        // Inicializar mapa
        function initMap() {
            try {
                map = L.map('map').setView([43.3623, -8.4115], 14);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                routeLayer = L.layerGroup().addTo(map);
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                document.getElementById('map').innerHTML = '<div class="error">Error al cargar el mapa</div>';
            }
        }
        
        // Obtener datos generales (líneas y paradas)
        async function getGeneralData() {
            console.log('📡 Iniciando getGeneralData...');
            console.log('📊 Estado de caché al inicio:');
            console.log('   - Líneas en caché:', Object.keys(linesData).length);
            console.log('   - Paradas en caché:', Object.keys(stopsData).length);
            
            // Intentar primero con localStorage
            const cachedData = getCache(CACHE_KEYS.GENERAL_DATA);
            if (cachedData) {
                console.log('🎯 [localStorage] Usando datos generales del caché');
                
                // Procesar datos del caché
                if (cachedData.iTranvias && cachedData.iTranvias.actualizacion) {
                    if (cachedData.iTranvias.actualizacion.lineas) {
                        cachedData.iTranvias.actualizacion.lineas.forEach(linea => {
                            linesData[linea.id] = linea;
                        });
                        console.log('Líneas cargadas desde caché:', Object.keys(linesData));
                    }
                    
                    if (cachedData.iTranvias.actualizacion.paradas) {
                        cachedData.iTranvias.actualizacion.paradas.forEach(parada => {
                            stopsData[parada.id] = parada;
                        });
                        console.log('Paradas cargadas desde caché:', Object.keys(stopsData).length);
                    }
                }
                
                // Obtener información específica de la línea
                await getLineData();
                return;
            }
            
            try {
                console.log('🌐 Intentando con backend...');
                const response = await fetch(`${BACKEND_API}/general`);
                
                if (!response.ok) {
                    throw new Error(`Error al obtener datos generales: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Datos generales recibidos del backend:', data);
                
                if (!data || !data.iTranvias || !data.iTranvias.actualizacion) {
                    throw new Error('Estructura de datos incorrecta');
                }
                
                // Guardar en caché localStorage
                setCache(CACHE_KEYS.GENERAL_DATA, data, CACHE_TTL.STATIC);
                
                // Procesar líneas
                if (data.iTranvias.actualizacion.lineas) {
                    data.iTranvias.actualizacion.lineas.forEach(linea => {
                        linesData[linea.id] = linea;
                    });
                    console.log('Líneas cargadas:', Object.keys(linesData));
                }
                
                // Procesar paradas
                if (data.iTranvias.actualizacion.paradas) {
                    data.iTranvias.actualizacion.paradas.forEach(parada => {
                        stopsData[parada.id] = parada;
                    });
                    console.log('Paradas cargadas:', Object.keys(stopsData).length);
                }
                
                // Obtener información específica de la línea
                console.log('Llamando a getLineData...');
                await getLineData();
                
            } catch (error) {
                console.error('❌ Error en getGeneralData:', error);
                console.error('Error details:', error.message);
                
                // Intentar con caché expirado como último recurso
                const expiredCache = localStorage.getItem(CACHE_KEYS.GENERAL_DATA);
                if (expiredCache) {
                    console.log('🆘 [localStorage] Usando caché expirado como último recurso');
                    try {
                        const cacheData = JSON.parse(expiredCache);
                        const data = cacheData.data;
                        
                        if (data && data.iTranvias && data.iTranvias.actualizacion) {
                            if (data.iTranvias.actualizacion.lineas) {
                                data.iTranvias.actualizacion.lineas.forEach(linea => {
                                    linesData[linea.id] = linea;
                                });
                            }
                            
                            if (data.iTranvias.actualizacion.paradas) {
                                data.iTranvias.actualizacion.paradas.forEach(parada => {
                                    stopsData[parada.id] = parada;
                                });
                            }
                            
                            await getLineData();
                            return;
                        }
                    } catch (cacheError) {
                        console.error('❌ Error procesando caché expirado:', cacheError);
                    }
                }
                
                showConnectionError();
            }
        }
        
        // Obtener datos específicos de una línea
        async function getLineData() {
            console.log('Iniciando getLineData...');
            
            const lineDataKey = CACHE_KEYS.LINE_DATA + currentRoute.apiLineId;
            
            // Intentar primero con localStorage
            const cachedData = getCache(lineDataKey);
            if (cachedData) {
                console.log(`🎯 [localStorage] Usando datos de línea ${currentRoute.apiLineId} del caché`);
                displayLineInfo();
                return;
            }
            
            try {
                console.log('Intentando con backend para datos de línea...');
                const response = await fetch(`${BACKEND_API}/line/${currentRoute.apiLineId}`);
                
                if (!response.ok) {
                    throw new Error('Error al obtener datos de la línea');
                }
                
                const data = await response.json();
                console.log(`Datos de línea ${currentRoute.apiLineId} recibidos del backend:`, data);
                
                // Guardar en caché localStorage
                setCache(lineDataKey, data, CACHE_TTL.STATIC);
                
                // Mostrar información de la línea
                displayLineInfo();
                
            } catch (error) {
                console.error('Error en getLineData:', error);
                
                // Intentar con caché expirado como último recurso
                const expiredCache = localStorage.getItem(lineDataKey);
                if (expiredCache) {
                    console.log(`🆘 [localStorage] Usando caché expirado para línea ${currentRoute.apiLineId}`);
                    displayLineInfo();
                    return;
                }
                
                // Si falla el backend, continuar con los datos ya cargados
                console.log('Continuando con datos ya cargados...');
                displayLineInfo();
            }
        }
        
        // Mostrar información de la línea
        function displayLineInfo() {
            console.log('🔍 Iniciando displayLineInfo...');
            console.log('📊 Líneas disponibles:', Object.keys(linesData));
            console.log('📍 Paradas disponibles:', Object.keys(stopsData));
            console.log('🎯 Buscando línea:', currentRoute.apiLineId, `(${currentRoute.line})`);
            
            // Buscar la línea correcta en los datos según la ruta seleccionada
            const currentLine = linesData[currentRoute.apiLineId];
            if (!currentLine) {
                console.error(`❌ No se encontró información de la línea ${currentRoute.line} (ID: ${currentRoute.apiLineId})`);
                console.error('🔍 Líneas disponibles en caché:', Object.keys(linesData));
                showConnectionError();
                return;
            }
            
            console.log(`✅ Línea ${currentRoute.line} encontrada:`, currentLine);
            console.log(`🛣️ Rutas de la línea ${currentRoute.line}:`, currentLine.rutas);
            
            // Obtener paradas de la línea actual
            const routeStops = [];
            
            // Las paradas vienen en el campo 'rutas' de la línea
            if (currentLine.rutas && currentLine.rutas.length > 0) {
                // Determinar qué ruta usar basándose en los puntos de origen y destino
                let rutaSeleccionada = null;
                let mejorCoincidencia = -1;
                
                console.log(`🔍 Analizando ${currentLine.rutas.length} rutas disponibles para línea ${currentRoute.line}`);
                
                // Buscar la ruta que contenga tanto el origen como el destino
                for (let rutaIndex = 0; rutaIndex < currentLine.rutas.length; rutaIndex++) {
                    const ruta = currentLine.rutas[rutaIndex];
                    console.log(`📋 Analizando ruta ${rutaIndex + 1}:`, ruta);
                    
                    if (ruta.paradas) {
                        const stopIds = ruta.paradas;
                        console.log(`📍 Paradas en ruta ${rutaIndex + 1}:`, stopIds);
                        
                        // Buscar índices de origen y destino en esta ruta
                        let startIndex = -1;
                        let endIndex = -1;
                        
                        for (let i = 0; i < stopIds.length; i++) {
                            if (stopIds[i] === currentRoute.originStop) {
                                startIndex = i;
                            }
                            if (stopIds[i] === currentRoute.destinationStop) {
                                endIndex = i;
                            }
                        }
                        
                        console.log(`🎯 Ruta ${rutaIndex + 1} - Índice origen: ${startIndex}, Índice destino: ${endIndex}`);
                        
                        // Si encontramos ambos puntos y están en orden correcto
                        if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                            const coincidencia = endIndex - startIndex + 1; // Número de paradas en el recorrido
                            console.log(`✅ Ruta ${rutaIndex + 1} válida con ${coincidencia} paradas en recorrido`);
                            
                            if (coincidencia > mejorCoincidencia) {
                                mejorCoincidencia = coincidencia;
                                rutaSeleccionada = ruta;
                                console.log(`🏆 Nueva mejor ruta encontrada: ruta ${rutaIndex + 1}`);
                            }
                        }
                    }
                }
                
                if (rutaSeleccionada) {
                    console.log('✅ Ruta seleccionada:', rutaSeleccionada);
                    
                    const stopIds = rutaSeleccionada.paradas;
                    console.log('IDs de paradas en la ruta seleccionada:', stopIds);
                    console.log('Origen buscado:', currentRoute.originStop);
                    console.log('Destino buscado:', currentRoute.destinationStop);
                    
                    // Buscar el recorrido entre origen y destino
                    let startIndex = -1;
                    let endIndex = -1;
                    
                    for (let i = 0; i < stopIds.length; i++) {
                        if (stopIds[i] === currentRoute.originStop) {
                            startIndex = i;
                        }
                        if (stopIds[i] === currentRoute.destinationStop) {
                            endIndex = i;
                        }
                    }
                    
                    console.log('Índice de inicio:', startIndex);
                    console.log('Índice de fin:', endIndex);
                    
                    if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                        // Obtener las paradas del recorrido
                        for (let i = startIndex; i <= endIndex; i++) {
                            const stopId = stopIds[i];
                            if (stopsData[stopId]) {
                                routeStops.push(stopsData[stopId]);
                            }
                        }
                    }
                } else {
                    console.warn('⚠️ No se encontró una ruta válida que contenga origen y destino');
                    console.log('🔍 Rutas disponibles:', currentLine.rutas);
                    console.log('🎯 Buscando origen:', currentRoute.originStop, 'destino:', currentRoute.destinationStop);
                }
            }
            
            console.log('Paradas del recorrido encontradas:', routeStops.length);
            displayStops(routeStops);
            displayMapRoute(routeStops);
        }
        
        // Mostrar lista de paradas
        function displayStops(stops) {
            console.log('Iniciando displayStops...');
            console.log('Paradas recibidas:', stops);
            
            const stopsList = document.getElementById('stopsList');
            stopsList.innerHTML = '';
            
            if (stops.length === 0) {
                console.log('No hay paradas para mostrar');
                stopsList.innerHTML = '<li class="error">No se encontraron paradas para este recorrido</li>';
                return;
            }
            
            console.log('Mostrando', stops.length, 'paradas');
            stops.forEach((stop, index) => {
                console.log('Procesando parada:', stop);
                const li = document.createElement('li');
                li.className = 'stop-item';
                
                if (stop.id === currentRoute.originStop) {
                    li.className += ' origin';
                } else if (stop.id === currentRoute.destinationStop) {
                    li.className += ' destination';
                }
                
                li.innerHTML = `${stop.id}. ${stop.nombre}`;
                stopsList.appendChild(li);
            });
            
            console.log('Lista de paradas actualizada');
        }
        
        // Mostrar ruta en el mapa
        function displayMapRoute(stops) {
            console.log('Iniciando displayMapRoute...');
            console.log('Paradas para el mapa:', stops);
            
            // Limpiar capa anterior
            if (routeLayer) {
                routeLayer.clearLayers();
            }
            
            if (stops.length === 0) {
                console.log('No hay paradas para mostrar en el mapa');
                return;
            }
            
            const markers = [];
            
            stops.forEach((stop, index) => {
                console.log('Procesando parada para mapa:', stop);
                let icon;
                
                if (stop.id === currentRoute.originStop) {
                    icon = L.divIcon({
                        html: `<div style="background-color: #4CAF50; color: white; padding: 5px; border-radius: 50%; font-weight: bold; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">${stop.id}</div>`,
                        iconSize: [30, 30],
                        className: 'custom-div-icon'
                    });
                } else if (stop.id === currentRoute.destinationStop) {
                    icon = L.divIcon({
                        html: `<div style="background-color: #f44336; color: white; padding: 5px; border-radius: 50%; font-weight: bold; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">${stop.id}</div>`,
                        iconSize: [30, 30],
                        className: 'custom-div-icon'
                    });
                } else {
                    icon = L.divIcon({
                        html: `<div style="background-color: #2196F3; color: white; padding: 3px; border-radius: 50%; font-weight: bold; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5);">${stop.id}</div>`,
                        iconSize: [25, 25],
                        className: 'custom-div-icon'
                    });
                }
                
                const lat = parseFloat(stop.posy);
                const lon = parseFloat(stop.posx);
                
                console.log('Coordenadas de la parada:', lat, lon);
                
                const marker = L.marker([lat, lon], { icon }).addTo(routeLayer);
                marker.bindPopup(`<b>${stop.nombre}</b><br>Parada ${stop.id}`);
                markers.push([lat, lon]);
            });
            
            // Dibujar línea de ruta
            if (markers.length > 1) {
                const polyline = L.polyline(markers, { 
                    color: '#2196F3', 
                    weight: 5,
                    opacity: 0.7
                }).addTo(routeLayer);
                
                // Ajustar vista del mapa
                map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                console.log('Ruta dibujada en el mapa');
            }
        }
        
        // Obtener horarios desde la API
        async function getScheduleData() {
            console.log('Iniciando getScheduleData...');
            
            try {
                const today = new Date();
                const fecha = today.toISOString().slice(0, 10).replace(/-/g, '');
                
                // Usar el ID de línea correcto desde la configuración
                const lineId = currentRoute.apiLineId;
                
                console.log('Intentando obtener horarios para línea:', lineId, 'fecha:', fecha);
                const response = await fetch(`${BACKEND_API}/schedule/${lineId}/${fecha}`);
                
                if (!response.ok) {
                    throw new Error(`Error al obtener horarios: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos de horarios recibidos del backend:', data);
                
                await displayScheduleInfo(data);
                
            } catch (error) {
                console.error('Error en getScheduleData:', error);
                console.error('Error details:', error.message);
                
                // Mostrar mensaje de error más específico en lugar de la tabla fija
                const scheduleInfo = document.getElementById('scheduleInfo');
                if (scheduleInfo) {
                    scheduleInfo.innerHTML = `
                        <div class="error">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                                <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error al cargar horarios</div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">No se pudieron obtener los horarios desde el servidor</div>
                                <div style="font-size: 12px; color: #999;">Verificando conexión con el servicio</div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Obtener tiempo de llegada en tiempo real
        async function getArrivalTime() {
            console.log('Iniciando getArrivalTime...');
            
            try {
                // Los enlaces no tienen estado disabled, pero podemos deshabilitarlos visualmente
                const updateLink = document.querySelector('a[onclick*="updateArrivalTime"]');
                if (updateLink) updateLink.style.pointerEvents = 'none';
                
                console.log('Intentando con backend para llegadas...');
                const response = await fetch(`${BACKEND_API}/arrivals/${currentRoute.originStop}`);
                
                if (!response.ok) {
                    throw new Error(`Error al obtener tiempos: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos de llegada recibidos del backend:', data);
                
                displayArrivalTimes(data);
                
            } catch (error) {
                console.error('Error en getArrivalTime:', error);
                console.error('Error details:', error.message);
                showConnectionError();
            } finally {
                // Rehabilitar el enlace
                const updateLink = document.querySelector('a[onclick*="updateArrivalTime"]');
                if (updateLink) updateLink.style.pointerEvents = 'auto';
            }
        }
        
        // Mostrar información de horarios
        async function displayScheduleInfo(data) {
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (!data || !data.servicios || data.servicios.length === 0) {
                scheduleInfo.innerHTML = `
                    <div class="error">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                            <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">No se pudieron cargar los horarios para hoy</div>
                            <div style="font-size: 14px; color: #999;">Verificando conexión con el servicio</div>
                        </div>
                    </div>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Tipo de día</th>
                                <th>Primera salida</th>
                                <th>Última salida</th>
                                <th>Frecuencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Laborables</td>
                                <td>6:30</td>
                                <td>22:30</td>
                                <td>10-15 min</td>
                            </tr>
                            <tr>
                                <td>Sábados</td>
                                <td>7:00</td>
                                <td>22:00</td>
                                <td>15-20 min</td>
                            </tr>
                            <tr>
                                <td>Domingos y festivos</td>
                                <td>8:00</td>
                                <td>21:30</td>
                                <td>20-30 min</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                return;
            }
            
            // Obtener datos de llegada en tiempo real para mostrar horarios próximos
            let arrivalData = null;
            try {
                const arrivalResponse = await fetch(`${BACKEND_API}/arrivals/${currentRoute.originStop}`);
                if (arrivalResponse.ok) {
                    arrivalData = await arrivalResponse.json();
                }
            } catch (error) {
                console.error('Error obteniendo datos de llegada para horarios próximos:', error);
            }
            
            // Almacenar datos de horarios globalmente para actualizaciones posteriores
            window.lastScheduleData = data;
            
            const servicio = data.servicios[0];
            const fecha = new Date(servicio.fecha.slice(0, 4), servicio.fecha.slice(4, 6) - 1, servicio.fecha.slice(6, 8));
            const tipoDia = servicio.tipo;
            
            // Convertir formato HHMM a formato HH:MM
            function formatoHHMMToHora(hhmm) {
                const horas = Math.floor(hhmm / 100);
                const mins = hhmm % 100;
                return `${horas.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
            
            // Obtener primera y última salida de ida
            const primeraSalidaIda = servicio.ida.length > 0 ? formatoHHMMToHora(servicio.ida[0]) : 'N/A';
            const ultimaSalidaIda = servicio.ida.length > 0 ? formatoHHMMToHora(servicio.ida[servicio.ida.length - 1]) : 'N/A';
            
            // Obtener primera y última salida de vuelta
            const primeraSalidaVuelta = servicio.vuelta.length > 0 ? formatoHHMMToHora(servicio.vuelta[0]) : 'N/A';
            const ultimaSalidaVuelta = servicio.vuelta.length > 0 ? formatoHHMMToHora(servicio.vuelta[servicio.vuelta.length - 1]) : 'N/A';
            
            // Calcular frecuencia aproximada (en minutos)
            const frecuenciaIda = servicio.ida.length > 1 ? 
                Math.round((servicio.ida[servicio.ida.length - 1] - servicio.ida[0]) / (servicio.ida.length - 1)) : 'N/A';
            const frecuenciaVuelta = servicio.vuelta.length > 1 ? 
                Math.round((servicio.vuelta[servicio.vuelta.length - 1] - servicio.vuelta[0]) / (servicio.vuelta.length - 1)) : 'N/A';
            
            // Obtener el nombre completo de la línea desde la API
            let nombreLinea = `${currentRoute.originName} → ${currentRoute.destinationName}`; // Fallback
            
            try {
                const response = await fetch(`${BACKEND_API}/line/${currentRoute.apiLineId}`);
                if (response.ok) {
                    const lineData = await response.json();
                    if (lineData && lineData.lineas && lineData.lineas.length > 0) {
                        const linea = lineData.lineas.find(l => l.id === currentRoute.apiLineId);
                        if (linea) {
                            // Para ida: orig_linea → dest_linea
                            // Para vuelta: dest_linea → orig_linea
                            const esIda = currentRoute.originStop === 42;
                            if (esIda) {
                                nombreLinea = `${linea.orig_linea} → ${linea.dest_linea}`;
                            } else {
                                nombreLinea = `${linea.dest_linea} → ${linea.orig_linea}`;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error obteniendo información de línea:', error);
            }
            
            // Determinar si usar horarios de ida o vuelta basándose en la ruta
            // Si la ruta va desde la parada 42 (casa) hacia otro lugar, es ida
            // Si la ruta va desde otro lugar hacia la parada 88 (casa), es vuelta
            const esIda = currentRoute.originStop === 42;
            const horarios = esIda ? servicio.ida : servicio.vuelta;
            const primeraSalida = horarios.length > 0 ? formatoHHMMToHora(horarios[0]) : 'N/A';
            const ultimaSalida = horarios.length > 0 ? formatoHHMMToHora(horarios[horarios.length - 1]) : 'N/A';
            
            // Calcular horarios próximos basándose en la hora actual
            const ahora = new Date();
            const horaActual = ahora.getHours() * 60 + ahora.getMinutes(); // minutos desde medianoche
            const diaActual = ahora.getDate();
            
            // Filtrar horarios próximos: última ya pasada (si no es del día anterior) y 4 siguientes
            const horariosProximos = [];
            let ultimaPasada = null;
            
            for (let i = 0; i < horarios.length; i++) {
                const horaHorario = Math.floor(horarios[i] / 100);
                const minHorario = horarios[i] % 100;
                const minutosHorario = horaHorario * 60 + minHorario;
                
                // Si es la última llegada ya pasada (pero no del día anterior)
                if (minutosHorario <= horaActual && minutosHorario > horaActual - 60) {
                    ultimaPasada = formatoHHMMToHora(horarios[i]);
                }
                // Si es una llegada futura
                else if (minutosHorario > horaActual) {
                    horariosProximos.push(formatoHHMMToHora(horarios[i]));
                    if (horariosProximos.length >= 4) break; // Las 4 siguientes
                }
            }
            
            // Calcular frecuencia promedio basándose en las diferencias entre buses consecutivos
            let frecuencia = 'N/A';
            if (horarios.length > 1) {
                let totalDiferencias = 0;
                let numDiferencias = 0;
                
                for (let i = 1; i < horarios.length; i++) {
                    // Convertir formato HHMM a minutos desde medianoche
                    const hora1 = Math.floor(horarios[i-1] / 100);
                    const min1 = horarios[i-1] % 100;
                    const minutos1 = hora1 * 60 + min1;
                    
                    const hora2 = Math.floor(horarios[i] / 100);
                    const min2 = horarios[i] % 100;
                    const minutos2 = hora2 * 60 + min2;
                    
                    const diferencia = minutos2 - minutos1;
                    totalDiferencias += diferencia;
                    numDiferencias++;
                }
                
                if (numDiferencias > 0) {
                    frecuencia = Math.round(totalDiferencias / numDiferencias);
                }
            }
            
            // Preparar información de horarios próximos
            let proximosHorarios = '';
            if (ultimaPasada || horariosProximos.length > 0) {
                const horariosTexto = [];
                if (ultimaPasada) {
                    horariosTexto.push(`<span style="color: #666; text-decoration: line-through;">${ultimaPasada}</span>`);
                }
                horariosProximos.forEach(horario => {
                    horariosTexto.push(`<span style="color: #4CAF50; font-weight: bold;">${horario}</span>`);
                });
                if (horariosProximos.length === 4) {
                    horariosTexto.push('<span style="color: #999;">...</span>');
                }
                proximosHorarios = horariosTexto.join(' → ');
            } else {
                proximosHorarios = '<span style="color: #999;">No hay horarios próximos</span>';
            }
            
            scheduleInfo.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e8f5e9; border-radius: 5px; border-left: 4px solid #4CAF50;">
                    <strong>📅 ${fecha.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}).replace(/^\w/, c => c.toUpperCase())} (día ${tipoDia.toLowerCase()})</strong>
                </div>
                

                
                <!-- Tarjetas de horarios -->
                <div class="schedule-cards">
                    <div class="schedule-card">
                        <div class="schedule-card-header">
                            Línea ${currentRoute.line}: ${nombreLinea}
                        </div>
                        <div class="schedule-card-row">
                            <span class="schedule-card-label">Primera salida:</span>
                            <span class="schedule-card-value">${primeraSalida}</span>
                        </div>
                        <div class="schedule-card-row">
                            <span class="schedule-card-label">Última salida:</span>
                            <span class="schedule-card-value">${ultimaSalida}</span>
                        </div>
                        <div class="schedule-card-row">
                            <span class="schedule-card-label">Frecuencia:</span>
                            <span class="schedule-card-value">${frecuencia !== 'N/A' ? frecuencia + ' min' : 'N/A'}</span>
                        </div>
                        <div class="schedule-card-row">
                            <span class="schedule-card-label">Total salidas:</span>
                            <span class="schedule-card-value">${horarios.length}</span>
                        </div>
                        <div class="schedule-card-row" style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #eee;">
                            <span class="schedule-card-label">🚌 Próximas salidas:</span>
                            <span class="schedule-card-value" style="text-align: left; flex: 1; margin-left: 10px;">${proximosHorarios}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Mostrar tiempos de llegada
        function displayArrivalTimes(data) {
            const arrivalsList = document.getElementById('arrivalsList');
            arrivalsList.innerHTML = '';
            
            if (!data || !data.buses || !data.buses.lineas) {
                arrivalsList.innerHTML = '<div class="error">No se pudieron cargar los datos de llegada</div>';
                return;
            }
            
            // Filtrar solo la línea actual
            const currentLineArrivals = [];
            const allLines = [];
            
            data.buses.lineas.forEach(linea => {
                // Mostrar información de todas las líneas para debug
                allLines.push(`Línea ${linea.linea}: ${linea.buses ? linea.buses.length : 0} buses`);
                
                if (linea.linea === parseInt(currentRoute.apiLineId)) {
                    if (linea.buses) {
                        linea.buses.forEach(bus => {
                            currentLineArrivals.push({
                                line: currentRoute.line,
                                minutes: parseInt(bus.tiempo),
                                destination: currentRoute.destinationName,
                                busId: bus.bus
                            });
                        });
                    }
                }
            });
            
            if (currentLineArrivals.length === 0) {
                arrivalsList.innerHTML = `
                    <div class="arrival-item">
                        <div style="color: #666; margin-bottom: 10px;">
                            <strong>No hay buses de la Línea ${currentRoute.line} en este momento</strong><br>
                            <div style="margin-top: 5px; font-size: 14px; color: #999;">
                                Dirección: ${currentRoute.originName} → ${currentRoute.destinationName}
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #999; margin-top: 10px;">
                            Los buses de la Línea ${currentRoute.line} pasan por esta parada pero no hay ninguno próximo.
                            <br><small>Líneas disponibles en la parada: ${allLines.join(', ')}</small>
                        </div>
                    </div>
                `;
            } else {
                // Ordenar por tiempo
                currentLineArrivals.sort((a, b) => a.minutes - b.minutes);
                
                // Mostrar los próximos 3 buses
                currentLineArrivals.slice(0, 3).forEach(arrival => {
                    const div = document.createElement('div');
                    div.className = 'arrival-item';
                    
                    const timeText = arrival.minutes === 0 ? 'Llegando' : 
                                   arrival.minutes === 1 ? '1 minuto' : 
                                   `${arrival.minutes} minutos`;
                    
                    div.innerHTML = `
                        <div>
                            <div class="arrival-line">Línea ${currentRoute.line}</div>
                        </div>
                        <div class="arrival-time">${timeText}</div>
                    `;
                    
                    arrivalsList.appendChild(div);
                });
            }
            
            // Actualizar hora
            const updateTime = document.getElementById('updateTime');
            const now = new Date();
            updateTime.innerHTML = `
                <div style="text-align: center; padding: 8px; font-size: 14px; color: #666;">
                    <span style="color: #2196F3; margin-right: 5px;">🕐</span>
                    <span style="font-weight: bold; color: #1976D2;">Última actualización:</span>
                    <span style="font-weight: bold; color: #333; margin: 0 5px;">
                        ${now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                    </span>
                    <span style="color: #999;">
                        ${now.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'})}
                    </span>
                </div>
            `;
        }
        
        // Mostrar error cuando no se pueden cargar los datos
        function showConnectionError() {
            // Limpiar caché en caso de error
            linesData = {};
            stopsData = {};
            
            const stopsList = document.getElementById('stopsList');
            stopsList.innerHTML = `
                <li class="error">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">❌</div>
                        <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error de conexión</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">No se pudo conectar con el servicio de autobuses</div>
                        <div style="font-size: 12px; color: #999;">Verifica tu conexión a internet e intenta de nuevo</div>
                    </div>
                </li>
            `;
            
            const arrivalsList = document.getElementById('arrivalsList');
            arrivalsList.innerHTML = `
                <div class="error">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">❌</div>
                        <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error de conexión</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">No se pueden cargar los tiempos de llegada</div>
                        <div style="font-size: 12px; color: #999;">Comprueba tu conexión a internet</div>
                    </div>
                </div>
            `;
            
            // No dibujar nada en el mapa
            if (routeLayer) {
                routeLayer.clearLayers();
            }
        }
        

        
        // Mostrar error específico de CORS
        function showCorsError() {
            // Limpiar caché en caso de error
            linesData = {};
            stopsData = {};
            
            const stopsList = document.getElementById('stopsList');
            stopsList.innerHTML = `
                <li class="error">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚫</div>
                        <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error de CORS</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">La API no permite peticiones desde el navegador</div>
                        <div style="font-size: 12px; color: #999;">Problema de configuración del servidor</div>
                    </div>
                </li>
            `;
            
            const arrivalsList = document.getElementById('arrivalsList');
            arrivalsList.innerHTML = `
                <div class="error">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚫</div>
                        <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error de CORS</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">La API no permite peticiones desde el navegador</div>
                        <div style="font-size: 12px; color: #999;">Problema de configuración del servidor</div>
                    </div>
                </div>
            `;
            
            // No dibujar nada en el mapa
            if (routeLayer) {
                routeLayer.clearLayers();
            }
        }
        
        // Actualizar tiempo de llegada
        function updateArrivalTime() {
            document.getElementById('arrivalsList').innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Actualizando...</div>
                        <div style="font-size: 14px; color: #999;">Obteniendo datos más recientes</div>
                    </div>
                </div>
            `;
            getArrivalTime();
        }
        
        // Función para limpiar completamente la caché
        function clearCache() {
            console.log('Limpiando caché completa...');
            linesData = {};
            stopsData = {};
            
            // Limpiar mapa
            if (routeLayer) {
                routeLayer.clearLayers();
            }
            
            // Limpiar todas las secciones con estados de carga apropiados
            const stopsList = document.getElementById('stopsList');
            const arrivalsList = document.getElementById('arrivalsList');
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (stopsList) stopsList.innerHTML = `
                <li class="loading">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 20px; margin-bottom: 8px;">📍</div>
                        <div style="font-size: 16px; color: #666;">Cargando paradas...</div>
                    </div>
                </li>
            `;
            if (arrivalsList) arrivalsList.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚌</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando tiempos de llegada...</div>
                        <div style="font-size: 14px; color: #999;">Conectando con el servicio en tiempo real</div>
                    </div>
                </div>
            `;
            if (scheduleInfo) scheduleInfo.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Cargando horarios...</div>
                        <div style="font-size: 14px; color: #999;">Obteniendo información actualizada</div>
                    </div>
                </div>
            `;
            
            console.log('Caché limpiada completamente');
        }
        
        // Función para recargar configuración de rutas
        async function reloadRoutesConfig() {
            console.log('🔄 Recargando configuración de rutas...');
            console.log('📊 Estado actual de rutas:', routesConfig);
            
            // Deshabilitar enlaces durante la recarga
            const reloadLink = document.querySelector('a[onclick*="reloadRoutesConfig"]');
            if (reloadLink) reloadLink.style.pointerEvents = 'none';
            
            try {
                // Recargar configuración de rutas forzando la recarga
                await loadRoutesConfig(true);
                
                // Recargar datos con la nueva configuración
                console.log('🧹 Limpiando caché...');
                clearCache();
                console.log('📡 Recargando datos generales...');
                await getGeneralData();
                console.log('📅 Recargando horarios...');
                getScheduleData();
                console.log('⏱️ Recargando tiempos de llegada...');
                getArrivalTime();
                
                console.log('✅ Configuración de rutas recargada correctamente');
                console.log('📊 Nuevo estado de rutas:', routesConfig);
            } catch (error) {
                console.error('Error recargando configuración de rutas:', error);
            } finally {
                // Rehabilitar enlaces después de la recarga
                setTimeout(() => {
                    if (reloadLink) reloadLink.style.pointerEvents = 'auto';
                }, 2000);
            }
        }
        

        
        // Función para recargar todo completamente
        function reloadEverything() {
            console.log('🔄 Iniciando recarga completa del sistema...');
            
            // Deshabilitar enlaces durante la recarga
            const updateLink = document.querySelector('a[onclick*="updateArrivalTime"]');
            const reloadLink = document.querySelector('a[onclick*="reloadEverything"]');
            if (updateLink) updateLink.style.pointerEvents = 'none';
            if (reloadLink) reloadLink.style.pointerEvents = 'none';
            
            // Mostrar mensaje de recarga
            const arrivalsList = document.getElementById('arrivalsList');
            if (arrivalsList) {
                arrivalsList.innerHTML = `
                    <div class="loading">
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                            <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Recargando todo...</div>
                            <div style="font-size: 14px; color: #999;">Limpiando caché y recargando datos</div>
                        </div>
                    </div>
                `;
            }
            
            // 1. Limpiar caché del Service Worker
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                console.log('🧹 Limpiando caché del Service Worker...');
                navigator.serviceWorker.controller.postMessage({
                    type: 'CLEAR_CACHE',
                    cacheType: 'all' // Limpiar todos los cachés del SW
                });
            }
            
            // 2. Limpiar caché localStorage
            console.log('🧹 Limpiando caché localStorage...');
            clearCache(); // Nuestra función personalizada
            
            // 3. Limpiar caché de JavaScript
            console.log('🧹 Limpiando caché de JavaScript...');
            linesData = {};
            stopsData = {};
            
            // 3. Limpiar mapa
            if (routeLayer) {
                routeLayer.clearLayers();
            }
            
            // 4. Limpiar todas las secciones
            const stopsList = document.getElementById('stopsList');
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (stopsList) stopsList.innerHTML = `
                <li class="loading">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 20px; margin-bottom: 8px;">📍</div>
                        <div style="font-size: 16px; color: #666;">Recargando paradas...</div>
                    </div>
                </li>
            `;
            
            if (scheduleInfo) scheduleInfo.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Recargando horarios...</div>
                        <div style="font-size: 14px; color: #999;">Obteniendo información actualizada</div>
                    </div>
                </div>
            `;
            
            // 5. Recargar todo con delay para asegurar que la caché se limpie
            setTimeout(async () => {
                try {
                    console.log('📡 Recargando configuración de rutas...');
                    await loadRoutesConfig(true);
                    
                    console.log('📡 Recargando datos generales...');
                    await getGeneralData();
                    
                    console.log('📅 Recargando horarios...');
                    getScheduleData();
                    
                    console.log('⏱️ Recargando tiempos de llegada...');
                    getArrivalTime();
                    
                    console.log('✅ Recarga completa finalizada');
                    
                } catch (error) {
                    console.error('❌ Error durante la recarga:', error);
                    
                    // Mostrar mensaje de error más específico
                    const scheduleInfo = document.getElementById('scheduleInfo');
                    if (scheduleInfo) {
                        scheduleInfo.innerHTML = `
                            <div class="error">
                                <div style="text-align: center; padding: 20px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                                    <div style="font-size: 16px; color: #c62828; margin-bottom: 10px;">Error durante la recarga</div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Intentando recarga completa de página...</div>
                                    <div style="font-size: 12px; color: #999;">Esto puede tardar unos segundos</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Si hay error, intentar recarga completa de página después de mostrar el mensaje
                    setTimeout(() => {
                        console.log('🔄 Intentando recarga completa de página...');
                        window.location.reload(true);
                    }, 2000);
                } finally {
                    // Rehabilitar enlaces después de la recarga
                    setTimeout(() => {
                        if (updateLink) updateLink.style.pointerEvents = 'auto';
                        if (reloadLink) reloadLink.style.pointerEvents = 'auto';
                    }, 2000);
                }
            }, 1000);
        }
        
        // Actualizar solo la hora de última actualización
        function updateTimeStamp() {
            const updateTime = document.getElementById('updateTime');
            const now = new Date();
            updateTime.innerHTML = `
                <div style="text-align: center; padding: 8px; font-size: 14px; color: #666;">
                    <span style="color: #2196F3; margin-right: 5px;">🕐</span>
                    <span style="font-weight: bold; color: #1976D2;">Última actualización:</span>
                    <span style="font-weight: bold; color: #333; margin: 0 5px;">
                        ${now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                    </span>
                    <span style="color: #999;">
                        ${now.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'})}
                    </span>
                </div>
            `;
        }
        
        // Actualizar horarios próximos basándose en la hora actual
        function updateProximosHorarios() {
            const scheduleInfo = document.getElementById('scheduleInfo');
            if (!scheduleInfo || !scheduleInfo.innerHTML.includes('schedule-cards')) {
                return; // No hay tarjetas de horarios visibles
            }
            
            // Buscar los datos de horarios almacenados globalmente
            if (!window.lastScheduleData || !window.lastScheduleData.servicios || window.lastScheduleData.servicios.length === 0) {
                return; // No hay datos de horarios disponibles
            }
            
            const servicio = window.lastScheduleData.servicios[0];
            const esIda = currentRoute.originStop === 42;
            const horarios = esIda ? servicio.ida : servicio.vuelta;
            
            if (horarios.length === 0) return;
            
            // Convertir formato HHMM a formato HH:MM
            function formatoHHMMToHora(hhmm) {
                const horas = Math.floor(hhmm / 100);
                const mins = hhmm % 100;
                return `${horas.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
            
            // Calcular horarios próximos basándose en la hora actual
            const ahora = new Date();
            const horaActual = ahora.getHours() * 60 + ahora.getMinutes();
            
            // Filtrar horarios próximos: última ya pasada y 4 siguientes
            const horariosProximos = [];
            let ultimaPasada = null;
            
            for (let i = 0; i < horarios.length; i++) {
                const horaHorario = Math.floor(horarios[i] / 100);
                const minHorario = horarios[i] % 100;
                const minutosHorario = horaHorario * 60 + minHorario;
                
                // Si es la última llegada ya pasada (pero no del día anterior)
                if (minutosHorario <= horaActual && minutosHorario > horaActual - 60) {
                    ultimaPasada = formatoHHMMToHora(horarios[i]);
                }
                // Si es una llegada futura
                else if (minutosHorario > horaActual) {
                    horariosProximos.push(formatoHHMMToHora(horarios[i]));
                    if (horariosProximos.length >= 4) break;
                }
            }
            
            // Preparar información de horarios próximos
            let proximosHorarios = '';
            if (ultimaPasada || horariosProximos.length > 0) {
                const horariosTexto = [];
                if (ultimaPasada) {
                    horariosTexto.push(`<span style="color: #666; text-decoration: line-through;">${ultimaPasada}</span>`);
                }
                horariosProximos.forEach(horario => {
                    horariosTexto.push(`<span style="color: #4CAF50; font-weight: bold;">${horario}</span>`);
                });
                if (horariosProximos.length === 4) {
                    horariosTexto.push('<span style="color: #999;">...</span>');
                }
                proximosHorarios = horariosTexto.join(' → ');
            } else {
                proximosHorarios = '<span style="color: #999;">No hay horarios próximos</span>';
            }
            
            // Actualizar solo la sección de horarios próximos en las tarjetas
            const proximosHorariosSpan = scheduleInfo.querySelector('.schedule-card-value');
            if (proximosHorariosSpan && proximosHorariosSpan.textContent.includes('Próximas salidas')) {
                proximosHorariosSpan.innerHTML = proximosHorarios;
            }
        }
        
        // Inicializar aplicación
        async function init() {
            console.log('Iniciando aplicación Bus Coruña...');
            
            // Cargar configuración de rutas primero
            await loadRoutesConfig();
            
            initMap();
            await getGeneralData();
            getScheduleData();
            getArrivalTime();
            
            // Actualizar tiempo de llegada cada 2 minutos
            setInterval(getArrivalTime, 120000);
            
            // Actualizar horarios cada día a las 00:00
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const timeUntilMidnight = tomorrow - now;
            
            setTimeout(() => {
                getScheduleData();
                // Luego actualizar cada día
                setInterval(getScheduleData, 24 * 60 * 60 * 1000);
            }, timeUntilMidnight);
            
            // Actualizar solo la hora cada minuto
            setInterval(updateTimeStamp, 60000);
            
            // Actualizar horarios próximos cada minuto
            setInterval(updateProximosHorarios, 60000);
            
            console.log('Aplicación iniciada correctamente');
        }
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Service Worker error:', err));
            });
        }
        
        // Iniciar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>